init python:
	gallery_cg = [
		"d1_food_normal", "d1_food_skolop", "d1_grasshopper",
		"d1_rena_sunset", "d1_sl_dinner", "d1_sl_dinner_0",
		"d1_uv", "d1_uv_2", "d2_2ch_beach",
		"d2_lineup", "d2_micu_lib", "d2_miku_piano",
		"d2_miku_piano2", "d2_mirror", "d2_slavya_forest", "d2_sovenok",
		"d2_ussr_falling", "d2_water_dan", "d3_disco",
		"d3_dv_guitar", "d3_dv_scene_1", "d3_dv_scene_2",
		"d3_sl_dance", "d3_sl_evening",
		"d3_sl_library", "d3_soccer", "d3_un_dance",
		"d3_un_forest", "d3_us_dinner", "d3_us_library_1",
		"d3_us_library_2", "d3_us_library_3", "d3_us_library_4",
		"d3_ussr_catched", "d4_catac", "d4_catac_dv",
		"d4_catac_sl", "d4_catac_un", "d4_catac_us",
		"d4_catac_us_2", "d4_dv_mt", "d4_el_wash",
		"d4_mi_guitar", "d4_mi_sing", "d4_sh_sit",
		"d4_sh_stay", "d4_us_cancer", "d4_us_morning",
		"d4_uv", "d4_uv_1", "d5_boat",
		"d5_boat_2", "d5_cake", "d5_clubs_robot",
		"d5_cs", "d5_dv_argue", "d5_dv_argue_2",
		"d5_dv_argue_3", "d5_dv_island",
		"d5_mi", "d5_sh_us", "d5_sl_sleep",
		"d5_sl_sleep_2", "d5_strawberry_race", "d5_un_island",
		"d5_un_sleep", "d5_us_ghost", "d5_us_ghost_2",
		"d5_us_kiss", "d5_us_sit", "d5_uv",
		"d5_uv_2", "d6_dv_fight", "d6_dv_fight_2",
		"d6_dv_fight_3",
		"d6_pioneer", "d6_sl_forest", "d6_sl_forest_2",
		"d6_un_evening_1", "d6_un_evening_2", "d6_un_punch",
		"d6_us_film", "d6_us_night_2", "d6_uv",
		"d6_uv_2", "d7_dv", "d7_dv_2",
		"d7_pioneers_leaving", "d7_pioneers_leaving_without_us",
		"d7_un_suicide", "d7_uv", "day4_us_morning",
		"epilogue_dv_2", "epilogue_dv_3", "epilogue_mi_1",
		"epilogue_mi_2", "epilogue_mi_3", "epilogue_mi_4",
		"epilogue_mi_5", "epilogue_mi_6", "epilogue_mi_7",
		"epilogue_mi_8", "epilogue_mi_9", "epilogue_sl",
		"epilogue_sl_2", "epilogue_un", "epilogue_un_bad",
		"epilogue_un_good", "epilogue_us", "epilogue_us_3_a",
		"epilogue_us_alone", "epilogue_uv", "epilogue_uv_2",
		"final_all_2", "epilogue_uv_uv",
		"epilogue_uv_sl", "epilogue_uv_dv", "epilogue_uv_un",
		"epilogue_uv_us", "epilogue_uv_mi",
	]
	gallery_cg.sort()
	
	gallery_bg = [
		"bus_stop", "ext_aidpost_day", "ext_aidpost_night",
		"ext_bathhouse_night", "ext_beach_day", "ext_beach_night",
		"ext_beach_sunset", "ext_boathouse_day", "ext_boathouse_night",
		"ext_bus", "ext_bus_night", "ext_camp_entrance_day",
		"ext_camp_entrance_night", "ext_clubs_day", "ext_clubs_night",
		"ext_dining_hall_away_day", "ext_dining_hall_away_night", "ext_dining_hall_away_sunset",
		"ext_dining_hall_near_day", "ext_dining_hall_near_night", "ext_dining_hall_near_sunset",
		"ext_house_of_dv_day", "ext_house_of_dv_night", "ext_house_of_mt_day",
		"ext_house_of_mt_night", "ext_house_of_mt_night_without_light", "ext_house_of_mt_sunset",
		"ext_house_of_sl_day", "ext_house_of_un_day", "ext_houses_day",
		"ext_houses_sunset", "ext_island_day", "ext_island_night",
		"ext_library_day", "ext_library_night", "ext_musclub_day",
		"ext_no_bus", "ext_no_bus_night", "ext_no_bus_sunset",
		"ext_old_building_night", "ext_old_building_night_moonlight", "ext_path_day",
		"ext_path_night", "ext_path_sunset", "ext_path2_day",
		"ext_path2_night", "ext_playground_day", "ext_playground_night",
		"ext_polyana_day", "ext_polyana_night", "ext_polyana_sunset",
		"ext_road_day", "ext_road_night", "ext_road_night2",
		"ext_road_sunset", "ext_square_day", "ext_square_day_city",
		"ext_square_night", "ext_square_night_party", "ext_square_night_party2",
		"ext_square_sunset", "ext_stage_big_night", "ext_stage_normal_day",
		"ext_stage_normal_night", "ext_washstand_day", "ext_washstand2_day",
		"int_aidpost_day", "int_aidpost_day_apple", "int_aidpost_night",
		"int_bus", "int_bus_black", "int_bus_night",
		"int_bus_people_day", "int_bus_people_night", "int_catacombs_door",
		"int_catacombs_entrance", "int_catacombs_hole", "int_catacombs_living",
		"int_catacombs_living_nodoor", "int_clubs_male_day", "int_clubs_male_sunset",
		"int_clubs_male2_night", "int_clubs_male2_night_nolight", "int_dining_hall_day",
		"int_dining_hall_night", "int_dining_hall_people_day", "int_dining_hall_sunset",
		"int_house_of_dv_day", "int_house_of_dv_night", "int_house_of_mt_day",
		"int_house_of_mt_night", "int_house_of_mt_night2", "int_house_of_mt_noitem_night",
		"int_house_of_mt_sunset", "int_house_of_sl_day", "int_house_of_un_day",
		"int_house_of_un_night", "int_liaz", "int_library_day",
		"int_library_night", "int_library_night2", "int_mine",
		"int_mine_coalface", "int_mine_crossroad", "int_mine_door",
		"int_mine_exit_night_light", "int_mine_exit_night_nolight", "int_mine_exit_night_torch",
		"int_mine_halt", "int_mine_room", "int_musclub_day",
		"int_old_building_night", "intro_xx", "semen_room",
		"semen_room_window",
	]
	gallery_bg.sort()
	
	cg_page = 0
	bg_page = 0
	bg_cg_page_size = 12
	bg_page_max = math.ceil(len(gallery_bg) / bg_cg_page_size)
	cg_page_max = math.ceil(len(gallery_cg) / bg_cg_page_size)
	
	bg_cg_blocked = 'images/gui/gallery/blocked.webp'
	def get_bg_cg_hover(path):
		cache = get_bg_cg_hover.__dict__
		if path not in cache:
			if path == bg_cg_blocked:
				cache[path] = path
			else:
				cache[path] = im.matrix_color(path, im.matrix.brightness(0.1))
		return cache[path]
	
	def get_bg_cg_on_page():
		page   = bg_page    if bg_or_cg == 'bg' else cg_page
		images = gallery_bg if bg_or_cg == 'bg' else gallery_cg
		
		start = page * bg_cg_page_size
		end   = start + bg_cg_page_size
		return images[start : end]
	
	def get_image_path(image_name):
		image_name = bg_or_cg + ' ' + image_name
		
		cache = get_image_path.__dict__
		if image_name not in cache:
			if not renpy.seen_image(image_name):
				cache[image_name] = bg_cg_blocked
			else:
				cmds = get_image(image_name)
				for cmd in cmds:
					cmd, filename, numline = cmd
					
					if cmd[0] in '"\'': # path in quotes
						path = cmd[1:-1]
						path = path.replace('/bg/', '/bg_small/')
						path = path.replace('/cg/', '/cg_small/')
						cache[image_name] = path
						break
				else:
					cache[image_name] = im.rect('#F00') # error
		
		return cache[image_name], image_name
	
	get_image_path.__dict__.clear() # clear bg_cg_cache every restart menu
	
	
	bg_cg_image = 'bg bus_stop'
	def show_gallery_image(image_name):
		global bg_cg_image
		bg_cg_image = image_name
		renpy.call('show_gallery_image')

init:
	image bg_cg_image = bg_cg_image


label show_gallery_image:
	$ db.skip_tab = False
	$ show_screen('dialogue_box')
	
	scene bg_cg_image with fade:
		align (1.0, 1.0)
		linear 3 align (0.0, 0.0)
	pause
	hide bg_cg_image with fade
	
	$ hide_screen('dialogue_box')

screen gallery_bg_cg:
	vbox:
		align 0.5
		spacing 75 / 1080
		
		$ images = get_bg_cg_on_page()
		
		for y in (0, 1, 2):
			
			hbox:
				spacing 85 / 1920
				
				for x in (0, 1, 2, 3):
					
					python:
						i = y * 4 + x
						if i < len(images):
							path, image_name = get_image_path(images[i])
						else:
							path = None
					
					if path:
						button:
							mouse  path != bg_cg_blocked
							action show_gallery_image(image_name) if path != bg_cg_blocked else None
							
							corner_sizes 0
							ground path
							hover  get_bg_cg_hover(path)
							
							xsize 320 / 1920
							ysize 180 / 1080
							
							image 'images/gui/gallery/hover.webp':
								xsize 320 / 1920
								ysize 180 / 1080
								corner_sizes 7
					else:
						null:
							xsize 320 / 1920
							ysize 180 / 1080
							
	
	
	if bg_or_cg == 'bg':
		if bg_page:
			button:
				style 'gallery_prev_btn'
				action 'bg_page -= 1'
		
		if bg_page != bg_page_max - 1:
			button:
				style 'gallery_next_btn'
				action 'bg_page += 1'
		
		text (str(bg_page + 1) + '/' + str(bg_page_max)):
			style 'gallery_page'
	
	else:
		if cg_page:
			button:
				style 'gallery_prev_btn'
				action 'cg_page -= 1'
		
		if cg_page != cg_page_max - 1:
			button:
				style 'gallery_next_btn'
				action 'cg_page += 1'
		
		text (str(cg_page + 1) + '/' + str(cg_page_max)):
			style 'gallery_page'
